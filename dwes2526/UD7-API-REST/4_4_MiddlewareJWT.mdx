## Práctica autenticación con JWT

Objetivo: usar **JWT** en Laravel 12 y probarlo con  **Thunder Client** , **sin middleware extra**

- solo el middleware de autenticación que identifica al `User`

> Laravel no trae JWT “de serie”: lo más directo es usar el paquete `php-open-source-saver/jwt-auth` (fork mantenido). ([GitHub](https://github.com/PHP-Open-Source-Saver/jwt-auth "GitHub - PHP-Open-Source-Saver/jwt-auth:  JSON Web Token Authentication for Laravel &amp; Lumen"))

---

## 1) Instalar JWT Auth y generar la clave

```bash
composer require php-open-source-saver/jwt-auth
php artisan vendor:publish --provider="PHPOpenSourceSaver\JWTAuth\Providers\LaravelServiceProvider"
php artisan jwt:secret
```

Esto crea `config/jwt.php` y añade `JWT_SECRET=...` en tu `.env`. ([laravel-jwt-auth.readthedocs.io](https://laravel-jwt-auth.readthedocs.io/en/stable/laravel-installation/ "Laravel Installation - Laravel JWT Auth"))

---

## 2) Preparar el modelo `User` (obligatorio)

En `app/Models/User.php` implementa `JWTSubject` y añade los métodos:

```php
<?php

namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;
use PHPOpenSourceSaver\JWTAuth\Contracts\JWTSubject;

class User extends Authenticatable implements JWTSubject
{
    // ... tus traits (HasFactory, Notifiable, etc.)

    public function getJWTIdentifier()
    {
        return $this->getKey();
    }

    public function getJWTCustomClaims(): array
    {
        return [];
    }
}
```

([laravel-jwt-auth.readthedocs.io](https://laravel-jwt-auth.readthedocs.io/en/stable/quick-start/ "Quick start - Laravel JWT Auth"))

---

## 3) Configurar el guard `api` para que use JWT

Edita `config/auth.php` y deja un guard `api` así:

```php
'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],

    'api' => [
        'driver' => 'jwt',
        'provider' => 'users',
    ],
],
```

> Consejo práctico: **no hace falta** cambiar `defaults.guard` si también usas login web; en rutas API usarás `auth:api`. ([laravel-jwt-auth.readthedocs.io](https://laravel-jwt-auth.readthedocs.io/en/stable/quick-start/ "Quick start - Laravel JWT Auth"))

---

## 4) Crear endpoints mínimos: login + me

### 4.1 Controlador

Crea un controlador:

```bash
php artisan make:controller Api/AuthController
```

`app/Http/Controllers/Api/AuthController.php`:

```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;

class AuthController extends Controller
{
    public function login(Request $request)
    {
        $credentials = $request->validate([
            'email' => ['required','email'],
            'password' => ['required','string'],
        ]);

        if (! $token = auth('api')->attempt($credentials)) {
            return response()->json(['message' => 'Invalid credentials'], 401);
        }

        // Devuelve el token en una clave simple para Thunder Client
        return response()->json([
            'token' => $token,
            'token_type' => 'Bearer',
        ]);
    }

    public function me()
    {
        return response()->json(auth('api')->user());
    }
}
```

### 4.2 Rutas

En `routes/api.php`:

```php
use App\Http\Controllers\Api\AuthController;
use Illuminate\Support\Facades\Route;

Route::post('/login', [AuthController::class, 'login']);

// ✅ SIN middleware extra: solo el que identifica al usuario por JWT
Route::middleware('auth:api')->get('/me', [AuthController::class, 'me']);
```

---

## 5) Thunder Client: obtener y guardar el token

### 5.1 Crear Environment

En Thunder Client →  **Env** :

* Crea un environment (p. ej. `local`)
* Variables:
  * `baseUrl` = `http://127.0.0.1:8000`
  * `token` = *(vacío)*

### 5.2 Request de Login

* **POST** `{{baseUrl}}/api/login`
* **Body** → tipo  **JSON** :

```json
{
  "email": "admin@demo.test",
  "password": "12345678"
}
```

### 5.3 Guardar token automáticamente

En la request del login, pestaña **Tests** →  **Set Env Variable** :

* **Source** : `json.token`
* **Value field** : `{{token}}`

Thunder Client soporta `json.propiedad` para extraer valores del JSON de respuesta. ([docs.thunderclient.com](https://docs.thunderclient.com/testing/set-env "Set Environment Variable – Thunder Client Docs"))

---

## 6) Thunder Client: usar el token en una ruta protegida

Request:

* **GET** `{{baseUrl}}/api/me`
* **Headers** :
* `Authorization: Bearer {{token}}`
* (opcional) `Accept: application/json`

Si el token es válido, `/api/me` devuelve el usuario autenticado.

---

### Errores típicos (para diagnosticar rápido)

* **401 en /api/login** → email/password incorrectos.
* **401 en /api/me** → falta header `Authorization` o `token` no se guardó / es inválido.
* **500** al autenticar → guard `api` mal configurado (driver `jwt`) o `User` no implementa `JWTSubject`.
