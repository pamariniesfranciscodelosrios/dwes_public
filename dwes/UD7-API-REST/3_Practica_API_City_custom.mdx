## UD7- API-Rest

Al trabajar con Laravel, no s√≥lo trabajaremos con **Monolito**, sino que tambi√©n lo haremos como BackEnd puro,

* Serviremos los datos a trav√©s de una [API REST (enlace)](https://aprendiendoarduino.wordpress.com/2019/10/27/api-rest/)
* Es importante comprender la teor√≠a de API Rest, sus verbos y las t√©cnicas y tecnolog√≠as m√°s usadas.
* Un segundo sistema, frontal, hace el consumo desde React, VUE...
* CRUD a trav√©s de API.

![1738074553383](image/readme/1738074553383.png)

[*Enlace Video GOGODEV Clase 6 API*](https://www.youtube.com/watch?v=YJrCBe4hx3Y)

---

---

**üá™üá∏**

El resultado de aprendizaje asociado a esta unidad es el **RA 7**:

??? note "RA7 Desarrolla servicios Web analizando su funcionamiento e implantando la estructura de sus componentes"

    > * A Se han reconocido las caracter√≠sticas propias y el √°mbito de aplicaci√≥n de los servicios Web.
    > *  B Se han reconocido las ventajas de utilizar servicios Web para proporcionar acceso a funcionalidades incorporadas a la l√≥gica de negocio de una aplicaci√≥n.
    > * C Se han identificado las tecnolog√≠as y los protocolos implicados en la publicaci√≥n y utilizaci√≥n de servicios Web.
    > *  D Se ha programado un servicio Web.
    > *  E Se ha creado el documento de descripci√≥n del servicio Web.
    > *  F Se ha verificado el funcionamiento del servicio Web.
    > *  G Se ha consumido el servicio Web.

---

# C√≥mo instalar API Rest en Laravel 12

[Enlace](https://www.cursosdesarrolloweb.es/blog/como-instalar-api-en-laravel)

**php artisan install:api**

Instalar la API en Laravel 11+ es sencillo: basta con ejecutar un comando, el cual crear√° lo necesario para poder desarrollar APIs en Laravel haciendo uso de Laravel Sanctum.

En versiones anteriores de Laravel, la API ya ven√≠a instalada y configurada por defecto.

## 1. Creaci√≥n API y Rutas Api

1. Crear proyecto

```sh
composer create-project laravel/laravel apicrud
```

```
INFO  Application key set successfully. 
```

Pueden ser entornos complementarios el hecho de tener un **monolito y una API** CRUD en el mismo proyecto; por ejemplo, un panel de admin con vistas y una API REST para servir a un cliente.

### Laravel 12 / install:api

Peque√±a actualizaci√≥n para Laravel 11+, puesto que no trae el API por defecto.

1. Ejecutar en la terminal
2. `php artisan install:api`
3. A√±adir en el archivo **User.php**
4. `use Laravel\Sanctum\HasApiTokens;`

![1738075138153](image/readme/1738075138153.png)

---

No necesariamente tendremos sistemas puramente backend o sistemas front, pueden ser **sistemas h√≠bridos**.

## 2. Crear BBDD

En el tutorial se crea la base de datos en Mysql, pero nosotros lo vemos en **sqlite**.

Ruta: `.env`

Cambiamos MySQL por sqlite y comentamos el resto del bloque:

```env
DB_CONNECTION=sqlite
#DB_HOST=127.0.0.1
#DB_PORT=3306
#DB_DATABASE=laravel
#DB_USERNAME=root
#DB_PASSWORD=
```

> Recuerda crear el fichero: `database/database.sqlite`

## 3. Modelo City y la migraci√≥n

Al igual que en el anterior proyecto CRUD con vistas, vamos a realizar un modelo **City** (ciudad) pero esta vez para servirlo con una **API REST**.

```sh
php artisan make:model City --migration
```

Con lo que obtenemos el OK y las rutas donde se ubican:

```sh
INFO  Model [app/Models/City.php] created successfully.  
INFO  Migration [database/migrations/xxxx_xx_xx_xxxxxx_create_cities_table.php] created successfully. 
```

### Modelo

Ruta: `app/Models/City.php`

* `hidden`: campos que NO quieres devolver en el JSON de respuesta
* `fillable/guarded`: campos que se pueden rellenar de forma masiva (mass assignment)

Como vamos a usar pocos campos, podemos dejar el modelo abierto usando `$guarded = []` (equivale a ‚Äútodo es rellenables‚Äù):

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class City extends Model
{
    use HasFactory;

    protected $guarded = []; 
}
```

### Migraci√≥n

Ruta: `database/migrations/xxxx_xx_xx_xxxxxx_create_cities_table.php`

Preparamos la creaci√≥n de la tabla `cities` y a√±adimos los campos necesarios:

* `name` (nombre de la ciudad)
* `population` (poblaci√≥n)
* `postalcode` (c√≥digo postal)

```php
/**
 * Run the migrations.
 */
public function up(): void
{
    Schema::create('cities', function (Blueprint $table) {
        $table->id();

        $table->string('name', 255);
        $table->unsignedInteger('population')->default(0);
        $table->string('postalcode', 10)->nullable();

        $table->timestamps();
    });
}
```

Ejecuta:

```sh
php artisan migrate
```

---

## 4. Rutas API (routes/api.php)

Ahora las rutas van en `routes/api.php` (recuerda haber instalado API con `php artisan install:api`).

* Al igual que en las rutas web, tenemos un route dispatcher para los diferentes m√©todos.
* Se asocia cada URI con su controlador.
* Vamos a hacer lo mismo pero en `api.php`.

Todav√≠a **no la vamos a proteger**, haremos una API **p√∫blica**, por lo que comentamos (si quieres) la ruta que trae por defecto Laravel con middleware Auth Sanctum.

!!! note "APIs p√∫blicas"

    Como seguro sabr√°s, existen m√∫ltiples APIs p√∫blicas para practicar y consumir sus datos desde el cliente

    ![1738075672603](image/readme/1738075672603.png)

---

## 5. Controlador --resource

Si queremos hacer la gesti√≥n de un CRUD podemos ahorrarnos la creaci√≥n de todas las funciones a√±adi√©ndole `--resource` al controlador.

```sh
php artisan make:controller CityController --resource
```

As√≠ Laravel nos genera los m√©todos t√≠picos: `index`, `store`, `show`, `update`, `destroy` (y tambi√©n `create/edit` aunque en API no se usan).

---

## 6. Registrar la ruta Resource en api.php

En `routes/api.php`:

```php
use App\Http\Controllers\CityController;
use Illuminate\Support\Facades\Route;

Route::resource('city', CityController::class);
```

Para comprobar las rutas generadas:

```sh
php artisan route:list
```

Ejemplo (orientativo) de rutas:

```txt
GET|HEAD        api/city ................................................................................ city.index ‚Ä∫ CityController@index
POST            api/city ................................................................................ city.store ‚Ä∫ CityController@store
GET|HEAD        api/city/create ......................................................................... city.create ‚Ä∫ CityController@create
GET|HEAD        api/city/{city} ......................................................................... city.show ‚Ä∫ CityController@show
PUT|PATCH       api/city/{city} ......................................................................... city.update ‚Ä∫ CityController@update
DELETE          api/city/{city} ......................................................................... city.destroy ‚Ä∫ CityController@destroy
GET|HEAD        api/city/{city}/edit ..................................................................... city.edit ‚Ä∫ CityController@edit
```

> **Nota:** `create` y `edit` son de vistas; en API normalmente no se usan. Si quieres evitar que se creen, usa `Route::apiResource(...)` y `--api` al crear el controlador.

---

## 7. CityController (API)

Ruta: `app/Http/Controllers/CityController.php`

Lo primero, incluir el modelo y el tipo de respuesta:

```php
use App\Models\City;
use Illuminate\Http\JsonResponse;
```

### Funci√≥n index (GET /api/city)

Recupera todas las ciudades y las devuelve como JSON:

```php
public function index(): JsonResponse
{
    $cities = City::all();
    return response()->json($cities, 200);
}
```

---

## 8. Validaci√≥n con CityRequest (recomendado)

Vamos a generar una request espec√≠fica en lugar de usar la `Request` gen√©rica. No es obligatorio, pero s√≠ muy recomendable.

```sh
php artisan make:request CityRequest
```

Ruta: `app/Http/Requests/CityRequest.php`

Cambiamos `authorize()` a true:

```php
public function authorize(): bool
{
    return true;
}
```

Y definimos reglas:

```php
public function rules(): array
{
    return [
        'name' => 'required|string|min:2|max:255',
        'population' => 'required|integer|min:0',
        'postalcode' => 'nullable|string|max:10',
    ];
}
```

En el controlador, importa la request:

```php
use App\Http\Requests\CityRequest;
```

---

## 9. Store (POST /api/city)

En una API, `store` es la acci√≥n para crear.

```php
public function store(CityRequest $request): JsonResponse
{
    $city = City::create($request->validated());

    return response()->json([
        'success' => true,
        'data' => $city
    ], 201);
}
```

---

## 10. Show (GET /api/city/{id})

Busca una ciudad por ID y la devuelve.

```php
public function show(string $id): JsonResponse
{
    $city = City::find($id);

    return response()->json($city, 200);
}
```

> Mejora t√≠pica: si no existe, devolver 404 (lo veremos m√°s adelante si quieres).

---

## 11. Update (PUT/PATCH /api/city/{id})

```php
public function update(CityRequest $request, string $id): JsonResponse
{
    $city = City::find($id);

    $city->name = $request->name;
    $city->population = $request->population;
    $city->postalcode = $request->postalcode;
    $city->save();

    return response()->json([
        'success' => true,
        'data' => $city
    ], 200);
}
```

---

## 12. Destroy (DELETE /api/city/{id})

```php
public function destroy(string $id): JsonResponse
{
    $city = City::find($id);

    if ($city) {
        $city->delete();
    }

    return response()->json([
        'success' => true
    ], 200);
}
```

---

## 13. Peticiones de cliente (Thunder Client)

Vamos a probarlo con la extensi√≥n de VSCode **Thunder Client** (o Postman).

Arranca el servidor:

```sh
php artisan serve
```

### Crear ciudad (POST)

URL:
`http://localhost:8000/api/city`

Body JSON de ejemplo:

```json
{
  "name": "C√≥rdoba",
  "population": 326039,
  "postalcode": "14001"
}
```

#### Index (GET)

`http://localhost:8000/api/city`

#### Update (PUT/PATCH)

`http://localhost:8000/api/city/1`

```json
{
  "name": "C√≥rdoba",
  "population": 328000,
  "postalcode": "14001"
}
```

#### Delete (DELETE)

`http://localhost:8000/api/city/1`

---

## 14. PROTECTED / HIDDEN

En el modelo puedes ocultar campos que NO quieres devolver en el JSON:

```php
protected $hidden = ['created_at', 'updated_at'];
```

As√≠ en el **index (GET /api/city)** ya no aparecer√°n esos campos.

---

## 15. ¬øC√≥mo puedo modificar los datos para devolverlos?

Si quieres transformar la respuesta (por ejemplo, renombrar campos, a√±adir textos, etc.) utiliza **API Resources**.

---

# API Resources

Vamos a crear un resource para definir exactamente qu√© se devuelve y c√≥mo.

```sh
php artisan make:resource CityResource
```

Ruta: `app/Http/Resources/CityResource.php`

Ejemplo (incluye un campo `example` que NO existe en la BD, a modo did√°ctico):

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class CityResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'name' => 'City: ' . $this->name,
            'population' => $this->population,
            'postalcode' => $this->postalcode,
            'example' => 'This is an example',
        ];
    }
}
```

---

## CityController usando CityResource

Importa el resource:

```php
use App\Http\Resources\CityResource;
use Illuminate\Http\Resources\Json\JsonResource;
```

### Index con Resource

```php
public function index(): JsonResource
{
    return CityResource::collection(City::all());
}
```

### Store devolviendo el recurso creado

```php
public function store(CityRequest $request): JsonResponse
{
    $city = City::create($request->validated());

    return response()->json([
        'success' => true,
        'data' => new CityResource($city),
    ], 201);
}
```

### Update devolviendo el recurso actualizado

```php
public function update(CityRequest $request, string $id): JsonResponse
{
    $city = City::find($id);

    $city->name = $request->name;
    $city->population = $request->population;
    $city->postalcode = $request->postalcode;
    $city->save();

    return response()->json([
        'success' => true,
        'data' => new CityResource($city),
    ], 200);
}
```

---

## Conclusiones

Aqu√≠ ya somos capaces de devolver datos tanto en vista como en API, y adem√°s controlar el formato de respuesta con **API Resources**.
